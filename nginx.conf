# Один worker обрабатывает 1024 подключений, улучшает производительность
events {
    worker_connections 1024;
}

# Полная конфигурация веб-сервера Nginx
http {
    # Настройки ограничения количества запросов от одного IP адреса
    limit_req_zone $binary_remote_addr zone=global:10m rate=50r/s;

    # Конкретно для сайта GymBoss
    server {
        # Базовые настройки сервера
        listen 80;
        server_name localhost cw187549.tw1.ru;
        server_tokens off; # Скрыть версию Nginx
        more_set_headers "Server: nginx"; # Убираем заголовок Server
        add_header X-Robots-Tag "none" always; # Анти-бот заголовки
        root /var/www/html;
        index index.php index.html;

        # Логи доступа и ошибок
        access_log /var/log/nginx/access.log;
        error_log  /var/log/nginx/error.log;

        # Сохранение статических файлов в кеше сервера на год
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options nosniff;
            try_files $uri =404;
        }

        # Все запросы перенаправляются на index.php (единая точка входа)
        location / {
            limit_req zone=global burst=100 nodelay;
            try_files $uri $uri/ /index.php?$query_string;
        }

        # Обработка всех PHP файлов
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass php:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

            # Таймауты для выполнения PHP
            fastcgi_read_timeout 60;
            fastcgi_send_timeout 60;
        }

        # Запрет доступа к важным файлам начинающимся с точки
        location ~ /\. {
            deny all;
            return 404;
        }

        # Запрет доступа к важным файлам в определенных директориях
        location ~* /(?:uploads|files|config|logs)/.*\.php$ {
            deny all;
        }

        # Настраиваем безопасные заголовки (Response headers, от сервера к браузеру), для защиты от атак
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; \
        script-src 'self' http: https: https://www.google.com https://www.gstatic.com https://gtmpx.com \
        https://api-maps.yandex.ru https://yastatic.net https://core-renderer-tiles.maps.yandex.net \
        https://cdn.jsdelivr.net https://code.jquery.com https://yookassa.ru 'unsafe-eval' 'unsafe-inline'; \
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; \
        img-src 'self' data: https: https://*.maps.yandex.net; \
        font-src 'self' data: https:; \
        connect-src 'self' http: https: https://www.google.com https://www.gstatic.com https://api-maps.yandex.ru \
        https://*.maps.yandex.net https://cdn.jsdelivr.net https://suggestions.dadata.ru https://yookassa.ru; \
        frame-src 'self' https://www.google.com https://www.gstatic.com;" always;

        # После рефакторинга поменять (строже)
        # add_header Content-Security-Policy "default-src 'self'; \
        # script-src 'self' https://www.google.com https://www.gstatic.com https://gtmpx.com \
        # https://api-maps.yandex.ru https://yastatic.net https://core-renderer-tiles.maps.yandex.net \
        # https://cdn.jsdelivr.net https://code.jquery.com https://yookassa.ru 'unsafe-inline'; \
        # style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; \
        # img-src 'self' data: https: https://*.maps.yandex.net; \
        # font-src 'self' data: https:; \
        # connect-src 'self' https://www.google.com https://www.gstatic.com https://api-maps.yandex.ru \
        # https://*.maps.yandex.net https://cdn.jsdelivr.net https://suggestions.dadata.ru https://yookassa.ru; \
        # frame-src 'self' https://www.google.com https://www.gstatic.com;" always;

        # Включаем и настраиваем gzip сжатие файлов (от серевра к браузеру)
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    }
}